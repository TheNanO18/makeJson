<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì»¬ëŸ¼ ë° Row ì„ íƒ</title>
    <style>
        /* CSSëŠ” ë³€ê²½ ì‚¬í•­ì´ ì—†ìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. */
        body { font-family: sans-serif; padding: 20px; }
        .section { border: 1px solid #ccc; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        h1, h2 { margin-top: 0; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:hover { background-color: #f5f5f5; }
        .table-container { max-height: 50vh; overflow-y: auto; }
        button { cursor: pointer; border-radius: 5px; border: none; padding: 10px 20px; font-size: 16px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 25px; border: 1px solid #888; width: 50%; border-radius: 5px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ì ìš©í•  ì»¬ëŸ¼ ë° ëŒ€ìƒ Row ì„ íƒ</h1>
    
    <button id="openHashModalBtn" type="button" style="margin-bottom: 20px; background-color: #007bff; color: white;">
        ğŸ”‘ íŒ¨ìŠ¤ì›Œë“œ í•´ì‹œ ì²˜ë¦¬ ì„¤ì •
    </button>

    <p>ì•„ë˜ í‘œì—ì„œ ì›í•˜ëŠ” Rowë¥¼ ì„ íƒí•˜ê³ , ì ìš©í•  ì»¬ëŸ¼ë“¤ì„ ì²´í¬í•œ í›„ 'JSON ìƒì„±' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>

    <form id="mainFilterForm" method="post">
        {% csrf_token %}
        
        <div class="section">
            <h2>ì ìš©í•  ì»¬ëŸ¼ ì„ íƒ</h2>
            {% for column in display_columns %}
                <label style="margin-right: 15px;">
                    <input type="checkbox" name="columns" value="{{ column }}" checked> {{ column }}
                </label>
            {% endfor %}
        </div>

        <div class="section">
            <h2>ëŒ€ìƒ Row ì„ íƒ</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox"></th>
                            {% for col_name in all_columns %}
                                <th>{{ col_name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for p_row in processed_rows %}
                            <tr>
                                <td><input type="checkbox" name="selected_pk_values" value="{{ p_row.pk_value }}"></td>
                                {% for cell in p_row.values %}
                                    <td>{{ cell }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <button type="submit" style="background-color: #28a745; color: white;">JSON ìƒì„± ë‹¨ê³„ë¡œ ì´ë™</button>
    </form>

    <div id="passwordHashModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>íŒ¨ìŠ¤ì›Œë“œ í•´ì‹œ ì²˜ë¦¬ ì„¤ì •</h2>
            <p>í•´ì‹œë¥¼ ì ìš©í•  ì»¬ëŸ¼ê³¼ ì•Œê³ ë¦¬ì¦˜ì„ ì„ íƒ í›„ 'ì ìš©' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
            
            <form id="hashForm">
                <div style="margin-bottom: 15px;">
                    <label for="passwordColumn" style="font-weight: bold; display: inline-block; width: 150px;">íŒ¨ìŠ¤ì›Œë“œ ì»¬ëŸ¼:</label>
                    <select name="password_column" id="passwordColumn" style="padding: 8px; font-size: 14px;">
                        {% for column in all_columns %}
                            <option value="{{ column }}">{{ column }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="hashAlgorithm" style="font-weight: bold; display: inline-block; width: 150px;">í•´ì‹œ ì•Œê³ ë¦¬ì¦˜:</label>
                    <select name="hash_algorithm" id="hashAlgorithm" style="padding: 8px; font-size: 14px;">
                        <option value="bcrypt">Bcrypt</option>
                        <option value="scrypt">Scrypt</option>
                        <option value="PBKDF2-SHA256">PBKDF2-SHA256</option>
                        <option value="Argon2">Argon2</option>
                    </select>
                </div>
                <hr style="margin: 20px 0;">
                <button type="button" id="applyHashInfoBtn" style="background-color: #007bff; color: white;">ì„¤ì • ì ìš©</button>
            </form>
        </div>
    </div>

    <script>
        // --- ê¸°ë³¸ í…Œì´ë¸” ì²´í¬ë°•ìŠ¤ ë¡œì§ (ë³€ê²½ ì—†ìŒ) ---
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const rowCheckboxes = document.querySelectorAll('input[name="selected_pk_values"]');
        selectAllCheckbox.addEventListener('change', function() {
            rowCheckboxes.forEach(checkbox => { checkbox.checked = this.checked; });
        });
        rowCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                selectAllCheckbox.checked = Array.from(rowCheckboxes).every(cb => cb.checked);
            });
        });

        // --- [ìˆ˜ì • 4] ëª¨ë‹¬ JavaScript ë¡œì§ ì „ì²´ ë³€ê²½ ---
        const modal = document.getElementById('passwordHashModal');
        const openBtn = document.getElementById('openHashModalBtn');
        const closeBtn = document.querySelector('.close-button');
        
        // ìƒˆë¡œìš´ ë¡œì§ì— í•„ìš”í•œ ìš”ì†Œë“¤
        const applyHashInfoBtn = document.getElementById('applyHashInfoBtn');
        const mainFilterForm = document.getElementById('mainFilterForm');
        const passwordColumnSelect = document.getElementById('passwordColumn');
        const hashAlgorithmSelect = document.getElementById('hashAlgorithm');

        // ëª¨ë‹¬ ì—´ê¸° (ë³€ê²½ ì—†ìŒ)
        openBtn.addEventListener('click', function() {
            modal.style.display = 'block';
        });

        // ëª¨ë‹¬ ë‹«ê¸° (ë³€ê²½ ì—†ìŒ)
        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        window.addEventListener('click', function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });

        // ğŸ”§ [í•µì‹¬] ëª¨ë‹¬ì˜ 'ì„¤ì • ì ìš©' ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œì§
        applyHashInfoBtn.addEventListener('click', function() {
            const p_col = passwordColumnSelect.value;
            const p_algo = hashAlgorithmSelect.value;

            // 1. ê¸°ì¡´ì— ì¶”ê°€í–ˆì„ ìˆ˜ ìˆëŠ” hidden inputë“¤ì„ ë¨¼ì € ì œê±°í•©ë‹ˆë‹¤. (ì¤‘ë³µ ë°©ì§€)
            const oldInputs = mainFilterForm.querySelectorAll('input[name^="password_hash_"]');
            oldInputs.forEach(input => input.remove());

            // 2. ìƒˆë¡œìš´ hidden inputë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤.
            const colInput = document.createElement('input');
            colInput.type = 'hidden';
            colInput.name = 'password_hash_column'; // views.pyì—ì„œ ë°›ì„ ì´ë¦„
            colInput.value = p_col;

            const algoInput = document.createElement('input');
            algoInput.type = 'hidden';
            algoInput.name = 'password_hash_algorithm'; // views.pyì—ì„œ ë°›ì„ ì´ë¦„
            algoInput.value = p_algo;

            // 3. ë©”ì¸ í¼ì— ìƒì„±í•œ inputë“¤ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
            mainFilterForm.appendChild(colInput);
            mainFilterForm.appendChild(algoInput);

            // 4. ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ê³  ëª¨ë‹¬ì„ ë‹«ìŠµë‹ˆë‹¤.
            alert(`íŒ¨ìŠ¤ì›Œë“œ í•´ì‹œ ì •ë³´ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n- ì»¬ëŸ¼: ${p_col}\n- ì•Œê³ ë¦¬ì¦˜: ${p_algo}\n\nì´ì œ 'JSON ìƒì„± ë‹¨ê³„ë¡œ ì´ë™' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
            modal.style.display = 'none';
        });
    </script>
</body>
</html>